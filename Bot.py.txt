import asyncio
import re
from aiogram import Bot, Dispatcher, Router, types
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.filters import CommandStart
from dotenv import load_dotenv
import os
import json
import smtplib
from email.mime.text import MIMEText

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω –∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è email –∏–∑ .env —Ñ–∞–π–ª–∞
load_dotenv()
API_TOKEN = os.getenv("TOKEN")
EMAIL_LOGIN = os.getenv("EMAIL_LOGIN")
EMAIL_PASSWORD = os.getenv("EMAIL_PASSWORD")

if not API_TOKEN or not EMAIL_LOGIN or not EMAIL_PASSWORD:
    print("‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env")
    exit()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=API_TOKEN)
dp = Dispatcher()
router = Router()

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è FSM
class UserState(StatesGroup):
    entering_email = State()
    entering_fio_phone = State()

# –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏)
user_data = {}
user_stats = {}

# –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (–ø–æ 20 –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –∫–∞–∂–¥–æ–º —Ç–µ—Å—Ç–µ)
tests = [
    {
        "name": "–¢–µ—Å—Ç 1",
        "questions": [
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ñ–ª—è—Ü–∏—è?", "options": ["–†–æ—Å—Ç —Ü–µ–Ω", "–ü–∞–¥–µ–Ω–∏–µ —Ü–µ–Ω", "–°—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ü–µ–Ω—ã"], "answer": 0},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–∫—Ç–∏–≤?", "options": ["–î–æ—Ö–æ–¥", "–ò–º—É—â–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏–Ω–æ—Å–∏—Ç –¥–æ—Ö–æ–¥", "–î–æ–ª–≥"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –ø–∞—Å—Å–∏–≤?", "options": ["–î–æ—Ö–æ–¥", "–ò–º—É—â–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ–∑–¥–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥—ã", "–†–µ–∑–µ—Ä–≤"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –∫–æ–º–ø–∞–Ω–∏–∏?", "options": ["–û—Ç—á–µ—Ç", "–ë–∞–ª–∞–Ω—Å", "–°–ø—Ä–∞–≤–∫–∞"], "answer": 1},
            {"q": "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä–∞ ROI?", "options": ["Rate of Interest", "Return on Investment", "Risk of Income"], "answer": 1},
            {"q": "–ö–∞–∫–æ–π –º–µ—Ç–æ–¥ —Ä–∞—Å—á–µ—Ç–∞ –∞–º–æ—Ä—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —Å—É–º–º—É?", "options": ["–õ–∏–Ω–µ–π–Ω—ã–π", "–ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π", "–î–µ–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤?", "options": ["–ê—É–¥–∏—Ç", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑", "–ö–æ–Ω—Ç—Ä–æ–ª—å"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–∫—Ü–∏–∏?", "options": ["–ö—Ä–µ–¥–∏—Ç", "–î–æ–ª—è –≤ –∫–æ–º–ø–∞–Ω–∏–∏", "–ì–æ—Ç—ñ–≤–∫–∞"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –≤—ã–ø–ª–∞—Ç–∞ –¥–æ—Ö–æ–¥–∞ –ø–æ –æ–±–ª–∏–≥–∞—Ü–∏—è–º?", "options": ["–î–∏–≤–∏–¥–µ–Ω–¥—ã", "–ü—Ä–æ—Ü–µ–Ω—Ç—ã", "–†–µ–Ω—Ç—ã"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å?", "options": ["–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–¥–∞—Ç—å –∞–∫—Ç–∏–≤", "–°—É–º–º–∞ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏", "–£—Ä–æ–≤–µ–Ω—å –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–±—ã–ª–∏ –∏ —É–±—ã—Ç–∫–∏?", "options": ["–ë–∞–ª–∞–Ω—Å", "–û—Ç—á–µ—Ç –æ –ø—Ä–∏–±—ã–ª—è—Ö –∏ —É–±—ã—Ç–∫–∞—Ö", "–û—Ç—á–µ—Ç –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫—Ä–µ–¥–∏—Ç?", "options": ["–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–ì–æ—Ç—ñ–≤–∫–∞", "–î–æ—Ö–æ–¥"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?", "options": ["–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "–î–æ—Ö–æ–¥—ã", "–ü—Ä–∏–±—ã–ª—å"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –¥–µ–ø–æ–∑–∏—Ç?", "options": ["–ö—Ä–µ–¥–∏—Ç", "–°–±–µ—Ä–µ–∂–µ–Ω–∏—è", "–î–æ—Ö–æ–¥"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω–µ–∂–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏?", "options": ["–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑", "–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"], "answer": 2},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏?", "options": ["–î–æ—Ö–æ–¥", "–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–ö—Ä–µ–¥–∏—Ç"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–∞–ª—é—Ç—ã?", "options": ["–ò–Ω—Ñ–ª—è—Ü–∏—è", "–î–µ—Ñ–ª—è—Ü–∏—è", "–°—Ç–∞–≥–Ω–∞—Ü–∏—è"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä?", "options": ["–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç", "–î–æ—Ö–æ–¥"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–∞–ª—é—Ç—ã?", "options": ["–ò–Ω—Ñ–ª—è—Ü–∏—è", "–î–µ—Ñ–ª—è—Ü–∏—è", "–°—Ç–∞–≥–Ω–∞—Ü–∏—è"], "answer": 0},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –±—é–¥–∂–µ—Ç?", "options": ["–ó–∞—Ä–ø–ª–∞—Ç–∞", "–ü–ª–∞–Ω –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤", "–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å"], "answer": 1},
        ]
    },
    {
        "name": "–¢–µ—Å—Ç 2",
        "questions": [
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫—Ä–µ–¥–∏—Ç–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥?", "options": ["–û—Ü–µ–Ω–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏", "–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞", "–û—Ü–µ–Ω–∫–∞ –∞–∫—Ç–∏–≤–æ–≤"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤?", "options": ["–ù–∞–ª–æ–≥–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å", "–ù–∞–ª–æ–≥–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è", "–ù–∞–ª–æ–≥–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –¥–µ–ø–æ–∑–∏—Ç–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç?", "options": ["–î–æ–∫—É–º–µ–Ω—Ç, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π –≤–∫–ª–∞–¥", "–î–æ–∫—É–º–µ–Ω—Ç, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π –∫—Ä–µ–¥–∏—Ç", "–î–æ–∫—É–º–µ–Ω—Ç, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–π –∞–∫—Ü–∏–∏"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞ –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π?", "options": ["–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "–î–æ—Ö–æ–¥—ã", "–ü—Ä–∏–±—ã–ª—å"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–∞—Å—á–µ—Ç–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞?", "options": ["–ï–¥–∏–Ω–∏—Ü–∞ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏", "–ï–¥–∏–Ω–∏—Ü–∞ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–µ–Ω–µ–≥", "–ï–¥–∏–Ω–∏—Ü–∞ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤?", "options": ["–ê—É–¥–∏—Ç", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑", "–ö–æ–Ω—Ç—Ä–æ–ª—å"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–∫—Ü–∏–∏?", "options": ["–ö—Ä–µ–¥–∏—Ç", "–î–æ–ª—è –≤ –∫–æ–º–ø–∞–Ω–∏–∏", "–ì–æ—Ç—ñ–≤–∫–∞"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –≤—ã–ø–ª–∞—Ç–∞ –¥–æ—Ö–æ–¥–∞ –ø–æ –æ–±–ª–∏–≥–∞—Ü–∏—è–º?", "options": ["–î–∏–≤–∏–¥–µ–Ω–¥—ã", "–ü—Ä–æ—Ü–µ–Ω—Ç—ã", "–†–µ–Ω—Ç—ã"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å?", "options": ["–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±—ã—Å—Ç—Ä–æ –ø—Ä–æ–¥–∞—Ç—å –∞–∫—Ç–∏–≤", "–°—É–º–º–∞ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏", "–£—Ä–æ–≤–µ–Ω—å –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥–æ–∫—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–±—ã–ª–∏ –∏ —É–±—ã—Ç–∫–∏?", "options": ["–ë–∞–ª–∞–Ω—Å", "–û—Ç—á–µ—Ç –æ –ø—Ä–∏–±—ã–ª—è—Ö –∏ —É–±—ã—Ç–∫–∞—Ö", "–û—Ç—á–µ—Ç –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫—Ä–µ–¥–∏—Ç?", "options": ["–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–ì–æ—Ç—ñ–≤–∫–∞", "–î–æ—Ö–æ–¥"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è?", "options": ["–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "–î–æ—Ö–æ–¥—ã", "–ü—Ä–∏–±—ã–ª—å"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –¥–µ–ø–æ–∑–∏—Ç?", "options": ["–ö—Ä–µ–¥–∏—Ç", "–°–±–µ—Ä–µ–∂–µ–Ω–∏—è", "–î–æ—Ö–æ–¥"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω–µ–∂–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏?", "options": ["–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑", "–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"], "answer": 2},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –æ–±–ª–∏–≥–∞—Ü–∏–∏?", "options": ["–î–æ—Ö–æ–¥", "–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–ö—Ä–µ–¥–∏—Ç"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–∞–ª—é—Ç—ã?", "options": ["–ò–Ω—Ñ–ª—è—Ü–∏—è", "–î–µ—Ñ–ª—è—Ü–∏—è", "–°—Ç–∞–≥–Ω–∞—Ü–∏—è"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä?", "options": ["–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç", "–î–æ—Ö–æ–¥"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤–∞–ª—é—Ç—ã?", "options": ["–ò–Ω—Ñ–ª—è—Ü–∏—è", "–î–µ—Ñ–ª—è—Ü–∏—è", "–°—Ç–∞–≥–Ω–∞—Ü–∏—è"], "answer": 0},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –±—é–¥–∂–µ—Ç?", "options": ["–ó–∞—Ä–ø–ª–∞—Ç–∞", "–ü–ª–∞–Ω –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤", "–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏?", "options": ["–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "–ö—Ä–µ–¥–∏—Ç", "–î–µ–ø–æ–∑–∏—Ç"], "answer": 0},
        ]
    },
    {
        "name": "–¢–µ—Å—Ç 3",
        "questions": [
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å?", "options": ["–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–ª–≥–æ–≤", "–î–æ—Ö–æ–¥ –ø—Ä–µ–≤—ã—à–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥—ã", "–°–±–µ—Ä–µ–∂–µ–Ω–∏—è"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –º–µ–∂–¥—É –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏?", "options": ["–ë—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ", "–°–±–µ—Ä–µ–∂–µ–Ω–∏–µ", "–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"], "answer": 0},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –ø–µ–Ω—Å–∏–æ–Ω–Ω—ã–π —Ñ–æ–Ω–¥?", "options": ["–§–æ–Ω–¥ –¥–ª—è –∑–∞—Ä–ø–ª–∞—Ç", "–§–æ–Ω–¥ –¥–ª—è –ø–µ–Ω—Å–∏–æ–Ω–Ω—ã—Ö –≤–∑–Ω–æ—Å–æ–≤", "–§–æ–Ω–¥ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∞–∫—Ç–∏–≤–æ–≤?", "options": ["–û—Ü–µ–Ω–∫–∞", "–ê–Ω–∞–ª–∏–∑", "–†–∞—Å—á–µ—Ç"], "answer": 0},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ä—ã–Ω–æ–∫ –∞–∫—Ü–∏–π?", "options": ["–ú–µ—Å—Ç–æ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏", "–ú–µ—Å—Ç–æ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –∞–∫—Ü–∏—è–º–∏", "–ú–µ—Å—Ç–æ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –≤–∞–ª—é—Ç–∞–º–∏"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞ –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–æ–≤?", "options": ["–î–µ–ø–æ–∑–∏—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç", "–î–µ–ø–æ–∑–∏—Ç–Ω—ã–π —Å—á–µ—Ç", "–î–µ–ø–æ–∑–∏—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑"], "answer": 0},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è?", "options": ["–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–±—ã–ª–∏", "–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–µ–Ω–µ–≥", "–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞ –æ—Ç –∞–∫—Ü–∏–π?", "options": ["–î–∏–≤–∏–¥–µ–Ω–¥—ã", "–ü—Ä–æ—Ü–µ–Ω—Ç—ã", "–†–µ–Ω—Ç—ã"], "answer": 0},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å?", "options": ["–ó–Ω–∞–Ω–∏—è –æ –¥–µ–Ω—å–≥–∞—Ö", "–ó–Ω–∞–Ω–∏—è –æ–± –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è—Ö", "–ó–Ω–∞–Ω–∏—è –æ –∫—Ä–µ–¥–∏—Ç–∞—Ö"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ–Ω–µ–∂–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏?", "options": ["–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑", "–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"], "answer": 2},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫—Ä–µ–¥–∏—Ç–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å?", "options": ["–û–±—â–∞—è —Å—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤", "–û–±—â–∞—è —Å—É–º–º–∞ –≤–∫–ª–∞–¥–æ–≤", "–û–±—â–∞—è —Å—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π"], "answer": 0},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–æ–≤?", "options": ["–ê—É–¥–∏—Ç", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑", "–†–∏—Å–∫–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑"], "answer": 2},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å?", "options": ["–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–î–æ—Ö–æ–¥", "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –¥–µ–Ω–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞"], "answer": 2},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞ –æ—Ç –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π?", "options": ["–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "–î–æ—Ö–æ–¥—ã", "–ü—Ä–∏–±—ã–ª—å"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å?", "options": ["–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å", "–î–æ—Ö–æ–¥", "–ó–∞—â–∏—Ç–∞ –¥–µ–Ω–µ–≥"], "answer": 2},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤?", "options": ["–ê—É–¥–∏—Ç", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑", "–ö–æ–Ω—Ç—Ä–æ–ª—å"], "answer": 1},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑?", "options": ["–ê–Ω–∞–ª–∏–∑ –∫—Ä–µ–¥–∏—Ç–æ–≤", "–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª–µ–π –∏ —É–±—ã—Ç–∫–æ–≤", "–ê–Ω–∞–ª–∏–∑ –∞–∫—Ç–∏–≤–æ–≤"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏?", "options": ["–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "–ö—Ä–µ–¥–∏—Ç", "–î–µ–ø–æ–∑–∏—Ç"], "answer": 0},
            {"q": "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–µ—à-—Ñ–ª–æ?", "options": ["–ó–∞—Ä–ø–ª–∞—Ç–∞", "–ü–æ—Ç–æ–∫ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç–∏", "–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å"], "answer": 1},
            {"q": "–ö–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ —Ä–∏—Å–∫–æ–≤?", "options": ["–ê—É–¥–∏—Ç", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑", "–†–∏—Å–∫–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑"], "answer": 2},
        ]
    }
]

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–µ—Å—Ç–∞
def get_result(score):
    if score <= 5:
        return "–ü–ª–æ—Ö–æ–π —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç"
    elif score <= 10:
        return "–°—Ä–µ–¥–Ω–∏–π —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç"
    elif score <= 15:
        return "–•–æ—Ä–æ—à–∏–π —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç"
    else:
        return "–û—Ç–ª–∏—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç"

# –ö–æ–º–∞–Ω–¥–∞ /start
@router.message(CommandStart())
async def send_welcome(message: Message):
    user_id = message.from_user.id
    user_name = message.from_user.username or "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id not in user_stats:
        user_stats[user_id] = {"username": user_name, "completed_tests": []}
    
    keyboard = ReplyKeyboardMarkup(
        resize_keyboard=True,
        one_time_keyboard=False,
        keyboard=[
            [KeyboardButton(text="–¢–µ—Å—Ç—ã")],
            [KeyboardButton(text="–ü—Ä–æ—Ñ–∏–ª—å")]
        ]
    )
    
    await message.answer(f"üëã –ü—Ä–∏–≤–µ—Ç, {user_name}! –Ø –±–æ—Ç –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤. –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=keyboard)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ—Å—Ç–∞
@router.message(lambda message: message.text == "–¢–µ—Å—Ç—ã")
async def handle_test_selection(message: Message):
    user_id = message.from_user.id
    
    keyboard = ReplyKeyboardMarkup(
        resize_keyboard=True,
        one_time_keyboard=False,
        keyboard=[
            [KeyboardButton(text="–¢–µ—Å—Ç 1")],
            [KeyboardButton(text="–¢–µ—Å—Ç 2")],
            [KeyboardButton(text="–¢–µ—Å—Ç 3")],
            [KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")]
        ]
    )
    
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç:", reply_markup=keyboard)

# –ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞
@router.message(lambda message: message.text in ["–¢–µ—Å—Ç 1", "–¢–µ—Å—Ç 2", "–¢–µ—Å—Ç 3"])
async def start_test(message: Message):
    user_id = message.from_user.id
    test_number = int(message.text.split()[1]) - 1
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ—Å—Ç—É
    if test_number > 0 and test_number - 1 not in user_stats[user_id]["completed_tests"]:
        await message.answer("‚ùå –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ç–µ—Å—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–π—Ç–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ—Å—Ç—ã.")
        return
    
    user_data[user_id] = {"score": 0, "q_index": 0, "test_number": test_number}
    await send_question(user_id)

# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
async def send_question(user_id):
    q_index = user_data[user_id]["q_index"]
    test_number = user_data[user_id]["test_number"]
    question = tests[test_number]["questions"][q_index]
    
    # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤
    keyboard_buttons = [[KeyboardButton(text=option)] for option in question["options"]]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –∏ "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
    extra_buttons = []
    if q_index > 0:
        extra_buttons.append([KeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥")])
    extra_buttons.append([KeyboardButton(text="üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")])
    
    keyboard = ReplyKeyboardMarkup(
        resize_keyboard=True,
        one_time_keyboard=False,
        keyboard=keyboard_buttons + extra_buttons
    )
    
    await bot.send_message(user_id, f"–ü–∏—Ç–∞–Ω–Ω—è {q_index + 1}: {question['q']}", reply_markup=keyboard)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
@router.message()
async def handle_answer(message: Message, state: FSMContext):
    user_id = message.from_user.id
    
    if user_id not in user_data:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Ç–µ—Å—Ç–∞
        if message.text == "–ü—Ä–æ—Ñ–∏–ª—å":
            await show_profile(message)
        elif message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
            await send_welcome(message)
        else:
            await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.")
        return
    
    q_index = user_data[user_id]["q_index"]
    test_number = user_data[user_id]["test_number"]
    
    if message.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥":
        if q_index > 0:
            user_data[user_id]["q_index"] -= 1
            await send_question(user_id)
        else:
            await message.answer("–≠—Ç–æ –ø–µ—Ä–≤–æ–µ –≤–æ–ø—Ä–æ—Å. –ù–∞–∑–∞–¥ –Ω–µ–ª—å–∑—è.")
        return
    
    if message.text == "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await send_welcome(message)
        user_data.pop(user_id, None)
        return
    
    question = tests[test_number]["questions"][q_index]
    if message.text in question["options"]:
        if message.text == question["options"][question["answer"]]:
            user_data[user_id]["score"] += 1
        user_data[user_id]["q_index"] += 1
        
        if user_data[user_id]["q_index"] < len(tests[test_number]["questions"]):
            await send_question(user_id)
        else:
            # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
            score = user_data[user_id]["score"]
            result = get_result(score)
            user_stats[user_id]["completed_tests"].append(test_number)
            
            if test_number == 1:
                await message.answer(f"‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score}/20 ({result})")
                await request_email(user_id)
            elif test_number == 2:
                await message.answer(f"‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score}/20 ({result})")
                await request_fio_phone(user_id)
            else:
                await message.answer(f"‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score}/20 ({result})")
                await send_welcome(message)
            
            user_data.pop(user_id, None)
    else:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.")

# –ó–∞–ø—Ä–æ—Å email –ø–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞
async def request_email(user_id):
    await bot.send_message(user_id, "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:")
    await UserState.entering_email.set()

@router.message(UserState.entering_email)
async def handle_email(message: Message, state: FSMContext):
    user_id = message.from_user.id
    email = message.text.strip()
    
    if not re.match(r"[^@]+@[^@]+\.[^@]+", email):
        await message.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email.")
        return
    
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ email
    try:
        score = user_data[user_id]["score"]
        result = get_result(score)
        msg = MIMEText(f"–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ 2: {score}/20 ({result})")
        msg['Subject'] = "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞"
        msg['From'] = EMAIL_LOGIN
        msg['To'] = email
        
        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
            server.login(EMAIL_LOGIN, EMAIL_PASSWORD)
            server.sendmail(EMAIL_LOGIN, email, msg.as_string())
        
        await message.answer("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤–∞—à email.")
    except Exception as e:
        await message.answer(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email: {e}")
    
    await state.clear()
    await send_welcome(message)

# –ó–∞–ø—Ä–æ—Å –§–ò–û –∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ—Å–ª–µ —Ç—Ä–µ—Ç—å–µ–≥–æ —Ç–µ—Å—Ç–∞
async def request_fio_phone(user_id):
    await bot.send_message(user_id, "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—Ä–µ—Ç—å–µ–≥–æ —Ç–µ—Å—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–±—Å—É–¥–∏—Ç—å —Å –Ω–∞—à–∏–º–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º–∏. –î–ª—è —ç—Ç–æ–≥–æ –æ—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –§–ò–û –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:")
    await UserState.entering_fio_phone.set()

@router.message(UserState.entering_fio_phone)
async def handle_fio_phone(message: Message, state: FSMContext):
    user_id = message.from_user.id
    fio_phone = message.text.strip()
    
    if len(fio_phone.split()) < 3 or not any(char.isdigit() for char in fio_phone):
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ –§–ò–û –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á +79991234567")
        return
    
    await message.answer("‚úÖ –°–ø–∞—Å–∏–±–æ! –ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã —Å–≤—è–∂—É—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.")
    await state.clear()
    await send_welcome(message)

# –ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def show_profile(message: Message):
    user_id = message.from_user.id
    
    if user_id not in user_stats:
        await message.answer("‚ùå –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ (/start).")
        return
    
    username = user_stats[user_id]["username"]
    completed_tests = user_stats[user_id]["completed_tests"]
    
    profile_text = f"üë§ –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {username}\n"
    profile_text += f"üìä –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: {', '.join([f'–¢–µ—Å—Ç {i+1}' for i in completed_tests]) if completed_tests else '–ù–µ—Ç'}\n"
    
    keyboard = ReplyKeyboardMarkup(
        resize_keyboard=True,
        one_time_keyboard=False,
        keyboard=[
            [KeyboardButton(text="–¢–µ—Å—Ç—ã")],
            [KeyboardButton(text="–ü—Ä–æ—Ñ–∏–ª—å")]
        ]
    )
    
    await message.answer(profile_text, reply_markup=keyboard)

# –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
def save_user_stats():
    with open('user_stats.json', 'w') as f:
        json.dump(user_stats, f)

def load_user_stats():
    global user_stats
    try:
        with open('user_stats.json', 'r') as f:
            user_stats = json.load(f)
    except FileNotFoundError:
        user_stats = {}

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    dp.include_router(router)
    load_user_stats()
    await dp.start_polling(bot)
    save_user_stats()

if __name__ == "__main__":
    asyncio.run(main())